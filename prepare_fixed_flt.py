"""
Big list of all of the FLTs reprocessed from the IMA files
"""

def go():
    import unicorn
    
    #### GOODS-N
    unicorn.prepare.make_IMA_FLT(raw='ib3701s4q_raw.fits', pop_reads=[1,2,3])
    
    # unicorn.prepare.show_MultiAccum_reads('ib3701skq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3701skq_raw.fits', pop_reads=[1,2,3])

    # unicorn.prepare.show_MultiAccum_reads('ib3702u8q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3702u8q_raw.fits', pop_reads=[1,2,3,4,5,6,7])

    # unicorn.prepare.show_MultiAccum_reads('ib3702uoq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3702uoq_raw.fits', pop_reads=[1,2,3,4,5,6,7,8])
    
    # unicorn.prepare.show_MultiAccum_reads('ib3703uzq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3703uzq_raw.fits', pop_reads=[1,2,3,4,5,6,7])

    # unicorn.prepare.show_MultiAccum_reads('ib3703vfq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3703vfq_raw.fits', pop_reads=[11,12,13])

    # unicorn.prepare.show_MultiAccum_reads('ib3703vmq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3703vmq_raw.fits', pop_reads=[1,2,3,4,8])
    
    # unicorn.prepare.show_MultiAccum_reads('ib3704wrq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3704wrq_raw.fits', pop_reads=[1,2])
    
    # unicorn.prepare.show_MultiAccum_reads('ib3704x8q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3704x8q_raw.fits', pop_reads=range(6,14))

    # unicorn.prepare.show_MultiAccum_reads('ib3705y1q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3705y1q_raw.fits', pop_reads=[1,2,3,4,5,6])

    # unicorn.prepare.show_MultiAccum_reads('ib3705y5q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3705y5q_raw.fits', pop_reads=[4])

    # unicorn.prepare.show_MultiAccum_reads('ib3705ylq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3705ylq_raw.fits', pop_reads=[4,5,6,7,8,9,10])

    # unicorn.prepare.show_MultiAccum_reads('ib3706b2q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3706b2q_raw.fits', pop_reads=[2,3,4,5,6,7])

    # unicorn.prepare.show_MultiAccum_reads('ib3706biq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3706biq_raw.fits', pop_reads=[12,13])
    
    # unicorn.prepare.show_MultiAccum_reads('ib3706bpq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3706bpq_raw.fits', pop_reads=[1,2,3])

    # unicorn.prepare.show_MultiAccum_reads('ib3707caq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3707caq_raw.fits', pop_reads=[1,2])

    # unicorn.prepare.show_MultiAccum_reads('ib3707cqq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3707cqq_raw.fits', pop_reads=[7,8,9,10,11,12])
    
    # unicorn.prepare.show_MultiAccum_reads('ib3708i5q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3708i5q_raw.fits', pop_reads=[7,8,9])

    # unicorn.prepare.show_MultiAccum_reads('ib3708ipq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3708ipq_raw.fits', pop_reads=[2,3,4,12])
    
    # unicorn.prepare.show_MultiAccum_reads('ib3709j3q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3709j3q_raw.fits', pop_reads=[7,8,9,10])

    # unicorn.prepare.show_MultiAccum_reads('ib3709joq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3709joq_raw.fits', pop_reads=[8,11,12,13])

    # unicorn.prepare.show_MultiAccum_reads('ib3710n6q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3710n6q_raw.fits', pop_reads=[])

    # unicorn.prepare.show_MultiAccum_reads('ib3710nmq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3710nmq_raw.fits', pop_reads=[12,13])

    # unicorn.prepare.show_MultiAccum_reads('ib3711bkq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3711bkq_raw.fits', pop_reads=[4])

    # unicorn.prepare.show_MultiAccum_reads('ib3716psq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3716psq_raw.fits', pop_reads=[12,13])

    #unicorn.prepare.show_MultiAccum_reads('ib3719v7q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3719v7q_raw.fits', pop_reads=[5])

    # unicorn.prepare.show_MultiAccum_reads('ib3724riq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3724riq_raw.fits', pop_reads=[13])

    # unicorn.prepare.show_MultiAccum_reads('ib3726bpq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3726bpq_raw.fits', pop_reads=[13])

    # unicorn.prepare.show_MultiAccum_reads('ib3726c5q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3726c5q_raw.fits', pop_reads=[10])

    # unicorn.prepare.show_MultiAccum_reads('ib3747zyq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3747zyq_raw.fits', pop_reads=[11])

    # unicorn.prepare.show_MultiAccum_reads('ib3747a5q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3747a5q_raw.fits', pop_reads=[5])
        
    # unicorn.prepare.show_MultiAccum_reads('ib3749o5q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3749o5q_raw.fits', pop_reads=[3])
    
    # unicorn.prepare.show_MultiAccum_reads('ib3749oqq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ib3749oqq_raw.fits', pop_reads=[11])

    
    #### 3D-HST
    ### GOODS-S
    # unicorn.prepare.show_MultiAccum_reads('ibhj10vmq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhj10vmq_raw.fits', pop_reads=[9])

    # unicorn.prepare.show_MultiAccum_reads('ibhj30bzq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhj30bzq_raw.fits', pop_reads=[6])
    
    # unicorn.prepare.show_MultiAccum_reads('ibhj36j3q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhj36j3q_raw.fits', pop_reads=[10])
    
    # unicorn.prepare.show_MultiAccum_reads('ibhj37uvq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhj37uvq_raw.fits', pop_reads=[11])
    
    ### AEGIS
    # unicorn.prepare.show_MultiAccum_reads('ibhj39uuq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhj39uuq_raw.fits', pop_reads=[9,10,11,12])
    
    # unicorn.prepare.show_MultiAccum_reads('ibhj39viq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhj39viq_raw.fits', pop_reads=[11,12,13])
    
    # unicorn.prepare.show_MultiAccum_reads('ibhj42oqq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhj42oqq_raw.fits', pop_reads=[10])
    
    # unicorn.prepare.show_MultiAccum_reads('ibhj59cvq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhj59cvq_raw.fits', pop_reads=[3])
        
    # unicorn.prepare.show_MultiAccum_reads('ibhj66dfq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhj66dfq_raw.fits', pop_reads=[3])
    
    # unicorn.prepare.show_MultiAccum_reads('ibhj69hgq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhj69hgq_raw.fits', pop_reads=[10,11,12])

    ### UDS
    # unicorn.prepare.show_MultiAccum_reads('ibhm05fjq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhm05fjq_raw.fits', pop_reads=[7])

    # # unicorn.prepare.show_MultiAccum_reads('ibhm12udq_raw.fits')
    # unicorn.prepare.make_IMA_FLT(raw='ibhm12udq_raw.fits', pop_reads=[])
    # 
    # # unicorn.prepare.show_MultiAccum_reads('ibhm12ukq_raw.fits')
    # unicorn.prepare.make_IMA_FLT(raw='ibhm12ukq_raw.fits', pop_reads=[])

    # unicorn.prepare.show_MultiAccum_reads('ibhm13kfq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhm13kfq_raw.fits', pop_reads=[6,7])

    # unicorn.prepare.show_MultiAccum_reads('ibhm14vhq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhm14vhq_raw.fits', pop_reads=[9])

    # unicorn.prepare.show_MultiAccum_reads('ibhm18oeq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhm18oeq_raw.fits', pop_reads=[2])

    # unicorn.prepare.show_MultiAccum_reads('ibhm19pjq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhm19pjq_raw.fits', pop_reads=[9])

    # unicorn.prepare.show_MultiAccum_reads('ibhm20l1q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhm20l1q_raw.fits', pop_reads=[10])

    # unicorn.prepare.show_MultiAccum_reads('ibhm24f8q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhm24f8q_raw.fits', pop_reads=[3])

    # unicorn.prepare.show_MultiAccum_reads('ibhm26n0q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhm26n0q_raw.fits', pop_reads=[9])

    # unicorn.prepare.show_MultiAccum_reads('ibhm27qiq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhm27qiq_raw.fits', pop_reads=[11])

    ### COSMOS
    # unicorn.prepare.show_MultiAccum_reads('ibhm31rcq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhm31rcq_raw.fits', pop_reads=[3])

    # unicorn.prepare.show_MultiAccum_reads('ibhm36ksq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhm36ksq_raw.fits', pop_reads=[11])

    # unicorn.prepare.show_MultiAccum_reads('ibhm38dfq_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhm38dfq_raw.fits', pop_reads=[5])

    # unicorn.prepare.show_MultiAccum_reads('ibhm45y1q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhm45y1q_raw.fits', pop_reads=[6])

    # unicorn.prepare.show_MultiAccum_reads('ibhm51x2q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhm51x2q_raw.fits', pop_reads=[5])

    # unicorn.prepare.show_MultiAccum_reads('ibhm53o3q_raw.fits')
    unicorn.prepare.make_IMA_FLT(raw='ibhm53o3q_raw.fits', pop_reads=[1])
    

def process_raw_all(field = 'AEGIS'):
    #### Reprocess *all* of the FLTs with variable backgrounds that 
    #### weren't already refit above
    import glob
    import os
    
    import numpy as np
    
    import unicorn
    import threedhst
    from threedhst import catIO
    
       
    files = glob.glob('/3DHST/Spectra/Work/BACKGROUND/%s/*G141_orbit.dat'%(field))
    redo_list = []
    for file in files:
        bg = catIO.Readfile(file, save_fits=False, force_lowercase=True)
        var_bg = np.ptp(bg.bg[1:]) > 0.15
        no_skip = True
        if os.path.exists('%sq_flt.fits' %(os.path.split(file)[-1].split('j_')[0])): 
            im2flt_key = threedhst.utils.gethead('%sq_flt.fits' %(os.path.split(file)[-1].split('j_')[0]), keys=['IMA2FLT'])
            if im2flt_key[0] == '': 
                no_skip = True
            else: 
                no_skip = False
        rawfile='%sq_raw.fits'%(os.path.split(file)[-1].split('j_')[0])
        #print rawfile, np.ptp(bg.bg[1:]), var_bg, no_skip, var_bg & no_skip
        #   
        if var_bg & no_skip:
            redo_list.append(rawfile)
            if not os.path.exists(rawfile):
                print '%s does not exist!'%(rawfile)
                continue
            #
            unicorn.prepare.make_IMA_FLT(raw=rawfile, pop_reads=[])
            
        
def redo_prep():
    """
    Redo prep steps on all of the grism pointings with the reprocessed
    FLT images.
    """
    import glob
    import threedhst
    import os
    
    files=glob.glob('*[0-9]-F140W_asn.fits')
    skip = True
    
    for file in files:
        if os.path.exists(file.replace('F140W_asn', 'G141_drz')) & skip:
            continue
        else:
            print file
        #
        if ('AEGIS-20' in file):
            continue
        #
        threedhst.prep_flt_files.process_3dhst_pair(file, file.replace('F140W', 'G141'), adjust_targname=False, ALIGN_IMAGE = None, SKIP_GRISM=False, GET_SHIFT=False, SKIP_DIRECT=True, align_geometry='rotate, shift', GRISM_HIGHER_ORDER=0)
            
    files=glob.glob('*[0-9]-G141_drz.fits')
    skip = True
    
    for file in files:
        if os.path.exists(file.replace('drz', 'inter')) & skip:
            continue
        else:
            print file
        #
        unicorn.reduce.set_grism_config(use_new_config=True)
        unicorn.reduce.interlace_combine(file.split('_drz')[0], pad=60, NGROW=125, view=False)
    
    #### Make models
    import unicorn
    import glob
    files=glob.glob('*inter.cat')
    for file in files:
        pointing=file.split('_inter')[0]
        unicorn.reduce.set_grism_config(grism='G141', use_new_config=True, force=True)
        model = unicorn.reduce.process_GrismModel(pointing, MAG_LIMIT=25, REFINE_MAG_LIMIT=22.5, make_zeroth_model=False, BEAMS=['A','B','C','D','E'])
        model.refine_mask_background(grow_mask=12, threshold=0.002, update=False)
        
    ### Extract spec-z objects
    import unicorn
    import glob
    import os
    
    files=glob.glob('*inter.cat')
    cat, zout, fout = unicorn.analysis.read_catalogs(files[0])
    
    #
    for file in files:
        pointing=file.split('_inter')[0]
        unicorn.reduce.set_grism_config(grism='G141', use_new_config=True, force=True)
        model = unicorn.reduce.process_GrismModel(pointing, MAG_LIMIT=25, REFINE_MAG_LIMIT=22.5, make_zeroth_model=False, BEAMS=['A','B','C','D','E'])
        ##
        for id in model.objects:
            zsp = zout.z_spec[zout.id == id][0]
            print '%s_%05d: %.4f' %(pointing, id, zsp)
            if os.path.exists('%s_%05d.2D.png' %(pointing, id)):
                continue
            #
            if zsp > 0:
                status = model.twod_spectrum(id, miny=-34, refine=False, CONTAMINATING_MAGLIMIT=25, USE_REFERENCE_THUMB=True)
                if status:
                    model.show_2d(savePNG=True)
                # unicorn.reduce.set_grism_config(grism='G141', use_new_config=True, force=True)
                # gris = unicorn.interlace_fit.GrismSpectrumFit('%s_%05d' %(pointing, id), lowz_thresh=0.)
                # gris.fit_in_steps(zrfirst=[np.clip(gris.z_peak-0.3, 0,3),gris.z_peak+0.3])
                # os.system('open %s_%05d*zfit*png' %(pointing, id))
                
    #
    import glob
    import unicorn
    SKIP=True
    files=glob.glob('*2D.fits')
    for file in files:
        if os.path.exists(file.replace('2D.fits','zfit.2D.png')) & SKIP:
            continue
        #
        unicorn.reduce.set_grism_config(grism='G141', use_new_config=True, force=True)
        pointing=file.split('_')[0]
        id=int(file.split('_')[1][:5])
        gris = unicorn.interlace_fit.GrismSpectrumFit('%s_%05d' %(pointing, id), lowz_thresh=0.)
        if gris.status:
            gris.fit_in_steps(zrfirst=[np.clip(gris.z_peak - 0.3*(1+gris.z_peak), 0,4),gris.z_peak + 0.3*(1+gris.z_peak)])
        #os.system('open %s_%05d*zfit*png' %(pointing, id))
        
    
    if False:
        status = model.twod_spectrum(id, miny=-34, refine=False, CONTAMINATING_MAGLIMIT=25, USE_REFERENCE_THUMB=True)
        if status:
            model.show_2d(savePNG=True)
        #
        gris = unicorn.interlace_fit.GrismSpectrumFit('%s_%05d' %(pointing, id), lowz_thresh=0.)
        if gris.status:
            gris.fit_in_steps(zrfirst=[np.clip(gris.z_peak - 0.3*(1+gris.z_peak), 0,4),gris.z_peak + 0.3*(1+gris.z_peak)])
        
    